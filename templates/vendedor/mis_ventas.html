{% extends "base.html" %}

{% block title %}Mis Ventas - Panel de Vendedor{% endblock %}

{% block content %}

<div class="page-header">
    <h1>
        <i class="fas fa-history"></i>
        Mis Ventas Realizadas
    </h1>
    {% if usuario %}
    <div class="info-vendedor" style="background: #e9ecef; padding: 10px 15px; border-radius: 8px; font-size: 14px; margin-top: 10px;">
        <i class="fas fa-user"></i> <strong>{{ usuario.nombre }}</strong> | 
        <i class="fas fa-tag"></i> {{ usuario.rol }} | 
        <i class="fas fa-id-badge"></i> ID: {{ usuario.id }}
    </div>
    {% endif %}
</div>

<!-- Filtros rápidos -->
<div class="filters-bar" style="margin-bottom: 20px;">
    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <a href="#" class="btn {% if filtro_actual == 'dia' %}btn-primary{% else %}btn-secondary{% endif %}">
            <i class="fas fa-sun"></i> Hoy
        </a>
        <a href="#" class="btn {% if filtro_actual == 'semana' %}btn-primary{% else %}btn-secondary{% endif %}">
            <i class="fas fa-calendar-week"></i> Esta Semana
        </a>
        <a href="#" class="btn {% if filtro_actual == 'mes' %}btn-primary{% else %}btn-secondary{% endif %}">
            <i class="fas fa-calendar-alt"></i> Este Mes
        </a>
        <a href="#" class="btn {% if filtro_actual == 'todo' %}btn-primary{% else %}btn-secondary{% endif %}">
            <i class="fas fa-infinity"></i> Todo
        </a>
    </div>
</div>

<!-- Tarjetas de resumen -->
{% if totales %}
<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 20px;">
    <div class="stats-card stats-card-primary">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <div class="stats-label">TOTAL VENTAS</div>
                <div class="stats-value">{{ totales.total_ventas }}</div>
            </div>
            <i class="fas fa-shopping-cart stats-icon"></i>
        </div>
    </div>
    
    <div class="stats-card stats-card-success">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <div class="stats-label">TOTAL RECAUDADO</div>
                <div class="stats-value">C$ {{ "{:,.0f}".format(totales.suma_total) }}</div>
            </div>
            <i class="fas fa-dollar-sign stats-icon"></i>
        </div>
    </div>
    
    <div class="stats-card stats-card-warning">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <div class="stats-label">PROMEDIO POR VENTA</div>
                <div class="stats-value">
                    C$ {% if totales.total_ventas > 0 %}
                        {{ "{:,.0f}".format(totales.suma_total / totales.total_ventas) }}
                    {% else %}
                        0
                    {% endif %}
                </div>
            </div>
            <i class="fas fa-chart-line stats-icon"></i>
        </div>
    </div>
    
    <div class="stats-card stats-card-info">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <div class="stats-label">TOTAL EFECTIVO</div>
                <div class="stats-value">C$ {{ "{:,.0f}".format(totales.suma_efectivo if totales.suma_efectivo else 0) }}</div>
            </div>
            <i class="fas fa-money-bill-wave stats-icon"></i>
        </div>
    </div>
</div>
{% endif %}

<!-- Tabla de ventas -->
<div class="table-container">
    <div style="padding: 15px 20px; border-bottom: 1px solid #eee; background-color: #f8f9fa; display: flex; justify-content: space-between; align-items: center;">
        <h3 style="margin: 0; font-size: 1.1rem;">
            <i class="fas fa-list" style="color: #0d6efd;"></i>
            Listado de Ventas
        </h3>
        <span class="badge primary" style="padding: 5px 10px;">
            {{ ventas|length }} venta(s) encontrada(s)
        </span>
    </div>
    
    <div style="padding: 20px;">
        {% if ventas and ventas|length > 0 %}
        <div style="overflow-x: auto;">
            <table class="table">
                <thead>
                    <tr>
                        <th class="text-center">ID</th>
                        <th>Fecha</th>
                        <th class="text-right">Total</th>
                        <th class="text-right">Efectivo</th>
                        <th class="text-right">Cambio</th>
                        <th>Vendedor</th>
                        <th class="text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for venta in ventas %}
                    <tr>
                        <td class="text-center"><strong>#{{ venta.id }}</strong></td>
                        <td>
                            <i class="fas fa-calendar-alt" style="color: #666; margin-right: 5px;"></i>
                            {{ venta.fecha_venta.strftime('%d/%m/%Y') }}
                        </td>
                        <td class="text-right" style="font-weight: bold; color: #0d6efd;">
                            C$ {{ "{:,.2f}".format(venta.total_venta) }}
                        </td>
                        <td class="text-right">C$ {{ "{:,.2f}".format(venta.efectivo) }}</td>
                        <td class="text-right">C$ {{ "{:,.2f}".format(venta.cambio) }}</td>
                        <td>
                            <span class="badge primary" style="padding: 4px 8px;">
                                <i class="fas fa-user-circle"></i>
                                {{ venta.nombre_vendedor }}
                            </span>
                        </td>
                        <td class="text-center">
                            <div style="display: flex; gap: 5px; justify-content: center;">
                                <button class="btn btn-small btn-edit" onclick="verDetalleVenta({{ venta.id }})" title="Ver detalles">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <a href="#" class="btn btn-small btn-primary" target="_blank" title="Imprimir ticket">
                                    <i class="fas fa-print"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div style="text-align: center; padding: 60px 20px;">
            <div style="font-size: 80px; color: #ccc; margin-bottom: 20px;">
                <i class="fas fa-receipt"></i>
            </div>
            <h3 style="color: #333; margin-bottom: 10px;">No hay ventas registradas</h3>
            <p style="color: #666; margin-bottom: 10px;">
                {% if usuario %}El vendedor <strong>{{ usuario.nombre }}</strong>{% endif %} aún no ha realizado ninguna venta.
            </p>
            <p style="color: #999; font-size: 14px; margin-bottom: 25px;">
                <i class="fas fa-info-circle"></i>
                ID del vendedor: {{ usuario.id if usuario else 'No disponible' }}
            </p>
            <a href="{{ url_for('nueva_venta') }}" class="btn btn-primary" style="padding: 12px 30px;">
                <i class="fas fa-plus"></i>
                Registrar Nueva Venta
            </a>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal para detalle de venta -->
<div id="detalleVentaModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h2>
                <i class="fas fa-receipt"></i>
                Detalle de Venta
            </h2>
            <button class="btn-close" onclick="cerrarModal()">&times;</button>
        </div>
        <div class="modal-body" id="detalleVentaBody">
            <!-- Contenido cargado dinámicamente -->
            <div class="text-center" style="padding: 40px;">
                <div class="spinner-border" style="width: 3rem; height: 3rem; color: #0d6efd;" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p style="margin-top: 15px; color: #666;">Cargando detalles...</p>
            </div>
        </div>
        <div class="form-actions" style="border-top: 1px solid #eee;">
            <button class="btn btn-secondary" onclick="cerrarModal()">Cerrar</button>
            <button class="btn btn-primary" id="btnImprimirModal" onclick="imprimirDetalleModal()">
                <i class="fas fa-print"></i>
                Imprimir
            </button>
        </div>
    </div>
</div>

<script>
// Variables globales
let ventaActualId = null;

// Función para ver detalle de venta
function verDetalleVenta(ventaId) {
    ventaActualId = ventaId;
    const modal = document.getElementById('detalleVentaModal');
    const modalBody = document.getElementById('detalleVentaBody');
    
    // Mostrar modal
    modal.style.display = 'block';
    
    // Cargar detalles vía AJAX
    fetch(`/ventas/detalle/${ventaId}`)
        .then(response => response.text())
        .then(html => {
            modalBody.innerHTML = html;
        })
        .catch(error => {
            modalBody.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #dc3545;">
                    <i class="fas fa-exclamation-circle" style="font-size: 48px; margin-bottom: 15px; display: block;"></i>
                    Error al cargar los detalles de la venta
                </div>
            `;
            console.error('Error:', error);
        });
}

// Función para cerrar modal
function cerrarModal() {
    document.getElementById('detalleVentaModal').style.display = 'none';
}

// Función para imprimir desde el modal
function imprimirDetalleModal() {
    if (ventaActualId) {
        window.open(`/ventas/imprimir/${ventaActualId}`, '_blank');
    }
}

// Cerrar modal si se hace clic fuera de él
window.addEventListener('click', function(event) {
    const modal = document.getElementById('detalleVentaModal');
    if (event.target == modal) {
        modal.style.display = 'none';
    }
});

// Cerrar con tecla ESC
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        document.getElementById('detalleVentaModal').style.display = 'none';
    }
});

// Búsqueda en tiempo real
document.addEventListener('DOMContentLoaded', function() {
    // Agregar campo de búsqueda si no existe
    const headerSection = document.querySelector('.table-container > div:first-child');
    if (headerSection && !document.getElementById('buscarVentas')) {
        const searchDiv = document.createElement('div');
        searchDiv.innerHTML = `
            <div style="display: flex; align-items: center;">
                <i class="fas fa-search" style="color: #666; margin-right: 10px;"></i>
                <input type="text" id="buscarVentas" placeholder="Buscar ventas..." style="padding: 8px 12px; border: 1px solid #ced4da; border-radius: 4px; width: 250px;">
            </div>
        `;
        headerSection.appendChild(searchDiv);
        
        const searchInput = document.getElementById('buscarVentas');
        searchInput.addEventListener('keyup', function() {
            const searchText = this.value.toLowerCase();
            const tableRows = document.querySelectorAll('.table tbody tr');
            
            tableRows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchText) ? '' : 'none';
            });
        });
    }
});
</script>

<style>
/* Estilos para badges primarios */
.badge.primary {
    background-color: #cfe2ff;
    color: #084298;
    padding: 4px 8px;
    border-radius: 10px;
    font-size: 12px;
    font-weight: 600;
}

/* Estilos para la información del vendedor */
.info-vendedor {
    background-color: #f8f9fa;
    border-left: 4px solid #0d6efd;
}

/* Estilos responsivos */
@media (max-width: 768px) {
    [style*="grid-template-columns: repeat(4, 1fr)"] {
        grid-template-columns: 1fr !important;
    }
    
    .table-container {
        overflow-x: auto;
    }
    
    .table th,
    .table td {
        min-width: 100px;
    }
    
    .table td:first-child {
        min-width: 60px;
    }
    
    .info-vendedor {
        font-size: 12px;
    }
}

/* Animación para el spinner */
.spinner-border {
    display: inline-block;
    width: 2rem;
    height: 2rem;
    vertical-align: text-bottom;
    border: 0.25em solid currentColor;
    border-right-color: transparent;
    border-radius: 50%;
    animation: spinner-border .75s linear infinite;
}

@keyframes spinner-border {
    to { transform: rotate(360deg); }
}

.visually-hidden {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    border: 0;
}

/* Estilos para botones pequeños */
.btn-small.btn-primary {
    background-color: #28a745;
    color: white;
    padding: 6px 10px;
}

.btn-small.btn-primary:hover {
    background-color: #218838;
}
</style>
{% endblock %}